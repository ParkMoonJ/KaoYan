
## 3.8 数据链路层设备

### 3.8.1 网桥的概念及其基本原理

两个或多个以太网通过网桥连接后，就成为一个覆盖范围更大的以太网，而原来的每个以太网就称为一个网段。网桥工作在链路层的 MAC 子层，可以使以太网各网段成为隔离开的碰撞域。如果把网桥换成工作在物理层的转发器，那么就没有这种过滤通信量的功能。由于各网段相对独立，因此一个网段的故障不会影响到另一个网段的运行。

> 注意：网桥处理数据的对象是帧，所以它是工作在数据链路层的设备，中继器、放大器处理数据的对象是信号，所以它是工作在物理层的设备。

网络 1 和网络 2 通过网桥连接后，网桥接收网络 1 发送的数据帧，检查数据帧中的地址，如果是网络 2 的地址，那么就转发给网络 2；如果是网络 1 的地址，那么就将其丢弃，因为源站和目的站处在同一个网段，目的站能够直接收到这个帧而不需要借助网桥转发。

如图 3.34 所示，设每个网段的数据率都是 10 Mb/s，那么三个网段合起来的最大吞吐量就变
成了 30 Mb/s，如果把两个网桥换成集线器或转发器，那么整个网络仍然是一个碰撞域（即冲突域），当 A 和 B 通信时，所有其他站点都不能通信，整个碰撞域的最大吞吐量仍然是 10 Mb/s。

网桥的基本特点：

1. 网桥必须具备寻址和路径选择能力，以确定帧的传输方向；
2. 从源网络接收帧，以目的网络的介质访问控制协议向目的网络转发该帧；
3. 网桥在不同或相同类型的 LAN 之间存储并转发帧，必要时还进行链路层上的协议转换。注意，一般情况下，存储转发类设备都能进行协议转换，即连接的两个网段可以使用不同的协议；
4. 网桥对接收到的帧不做任何修改，或只对帧的封装格式做很少的修改；
5. 网桥可以通过执行帧翻译互联不同类型的局域网，即把原协议的信息段的内容作为另-种协议的信息部分封装在帧中；
6. 网桥应有足够大的缓冲空间，因为在短时间内帧的到达速率可能高于转发速率。

网桥的优点：
1. 能过滤通信量；
2. 扩大了物理范围；
3. 可使用不同的物理层；
4. 可互联不同类型的局域网；
5. 提高了可靠性；
6. 性能得到改善。

网桥的缺点：
1. 增大了时延；
2. MAC 子层没有流量控制功能（流量控制需要用到编号机制，编号机制的实现在 LLC 子层）；
3. 不同 MAC 子层的网段桥接在一起时，需要进行帧格式的转换；
4. 网桥只适合于用户数不多和通信量不大的局域网，否则有时还会因传播过多的广播信息而产生网络拥塞，这就是所谓的广播风暴。

网桥必须具有路径选择的功能，接收到帧后，要决定正确的路径，将该帧转送到相应的目的
局域网站点。根据路径选择算法的不同，可将网桥分为透明网桥和源路由网桥。

#### 1. 透明网桥（选择的不是最佳路由）

透明网桥以混杂方式工作，它接收与之连接的所有 LAN 传送的每一帧。到达帧的路由选择
过程取决于源 LAN 和目的 LAN：

1. 如果源 LAN 和目的 LAN 相同，那么丢弃该帧；
2. 如果源 LAN 和目的 LAN 不同，那么转发该帧；
3. 如果目的 LAN 未知，那么扩散该帧。

当网桥刚连接到以太网时，其转发表是空的，网桥按照自学习算法处理收到的帧。该算法的基本思想是：若从站 A 发出的帧从某端口进入网桥，那么从这个端口出发沿相反方向一定可把一个帧传送到站 A 。所以网桥每收到一个帧，就记下其源地址和进入网桥的端口，作为转发表中的一个项目（源地址、进入的接口和时间）。在建立转发表时，把帧首部中的源地址写在「地址」一栏的下面。在转发帧时，则根据收到的帧首部中的目的地址来转发。这时就把在「地址」栏下面已经记下的源地址当作目的地址，而把记下的进入端口当作转发端口。网桥就是在这样的转发过程中逐渐将其转发表建立起来的。

为了避免转发的帧在网络中不断地「兜圈子」，透明网桥使用了一种生成树算法（无环），以确保每个源到每个目的地只有唯一的路径。 生成树使得整个扩展局域网在逻辑上形成树形结构，所以工作时逻辑上没有环路，但生成树一般不是最佳路由。

#### 2. 源路由网桥（选择的是最佳路由）

在源路由网桥中，路由选择由发送数据帧的源站负责，网桥只根据数据真正的路由信息对帧进行接收和转发。

源路由网桥对主机是不透明的，主机必须知道网桥的标识及连接到哪个网段上。路由选择由发送帧的源站负责，那么源站如何知道应当选择什么样的路由呢？为了找到最佳的路由，源站以广播方式向目的站发送一个发现帧（Discovery Frame）作为探测之用。源路由的生成过程是：在未知路径前，源站要先发送一个发现帧；途中的每个网桥都转发此帧，最终该发现帧可能从多个途径到达目的站：目的站也将一一发送应答帧；每个应答帧将通过原路径返回，途经的网桥把自己的标志记录在应答帧中；源站选择出一个最佳路由。以后，凡从这个源站向该目的站发送的帧的首部，都必须携带这一路由信息。

此外，发送帧还可以帮助源站确定整个网络可以通过的帧的最大长度。由于发现帧的数量指
数式增加，可能会使网络严重拥塞。

#### 3. 两种网桥的比较

使用源路由网桥可以利用最佳路由。若在两个以太网之间使用并联的源路由网桥，则还可使通信量较平均地分配给每个网桥。采用透明网桥时，只能使用生成树，而使用生成树一般并不能保证所用的路由是最佳的，也不能在不同的链路中进行负载均衡。

> 注意：透明网桥和源路由网桥中提到的最佳路由并不是经过路由器最少的路由，而可以是发送帧往返时间最短的路由，这样才能真正地进行负载平衡，因为往返时间长说明中间某个路由器可能超载了，所以不走这条路，换个往返时间短的路走。

### 3.8.2 局域网交换机及其工作原理

#### 1. 局城网交换机

桥接器的主要限制是在任一时刻通常只能执行一个帧的转发操作，于是出现了局域网交换机，又称以太网交换机。从本质上说，以太网交换机是一个多端口的网桥，它工作在数据链路层。交换机能经济地将网络分成小的冲突域，为每个工作站提供更高的带宽。

以太网交换机对工作站是透明的，因此管理开销低廉，简化了网络结点的增加、移动和网络变化的操作。利用以太网交换机还可以方便地实现虚拟局域网（Virtual LAN，VLAN），VLAN 不仅可以隔离冲突域，而且可以隔离广播域。

#### 2. 原理

以太网交换机的原理是，它检测从以太端口来的数据帧的源和目的地的 MAC（介质访问层）地址，然后与系统内部的动态查找表进行比较，若数据帧的 MAC 地址不在查找表中，则将该地址加入查找表，并将数据帧发送给相应的目的端口。

#### 3. 特点

以太网交换机的特点如下:

1. 以太网交换机的每个端口都直接与单台主机相连（普通网桥的端口往往连接到以太网的一个网段），并且一般都工作在全双工方式。
2. 以太网交换机能同时连通许多对端口，使每对相互通信的主机都能像独占通信媒体那样，无碰撞地传输数据。
3. 以太网交换机也是一种即插即用设备（和透明网桥一样），其内部的帧的转发表也是通过自学习算法自动地逐渐建立起来的。
4. 以太网交换机由于使用了专用的交换结构芯片，因此交换速率较高。
5. 以太网交换机独占传输媒体的带宽。

对于传统 10 Mb/s 的共享式以太网，若共有 N 个用户，则每个用户占有的平均带宽只有总带
宽（10 Mb/s）的 $\frac{1}{N}$。在使用以太网交换机时，虽然在每个端口到主机的带宽还是 10 Mb/s，但由于一个用户在通信时是独占而不是和其他网络用户共享传输媒体的带宽，因此拥有 N 个端口的交换机的总容量为 $N \times 10 Mb/s$。这正是交换机的最大优点。

以太网交换机一般都具有多种速率的端口，例如可以具有 10 Mb/s、100 Mb/s 和 1 Gb/s 的端口的各种组合，因此大大方便了各种不同情况的用户。

#### 4. 两种交换模式

目前，以太网交换机主要采用两种交换模式，即直通式和存储转发式。

1. 直通式交换机只检查帧的目的地址，这使得帧在接收后几乎能马上被传出去。这种方式速度快，但缺乏智能性和安全性，也无法支持具有不同速率的端口的交换。
2. 存储转发式交换机先将接收到的帧缓存到高速缓存器中，并检查数据是否正确，确认无误后通过查找表转换成输出端口将该帧发送出去。如果发现帧有错，那么就将其丢弃。存储转发式的优点是可靠性高，并能支持不同速率端口间的转换，缺点是延迟较大。
